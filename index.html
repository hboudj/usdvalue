<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>USD Value Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 40px; text-align: center; }
    h1 { color: #333; }
    .converter { background: white; padding: 30px; border-radius: 10px; display: inline-block; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    select, input[type="radio"] { margin: 10px; }
    .hidden { display: none; }
    #result { margin-top: 20px; font-size: 24px; color: #2a2a2a; }
    label { font-weight: bold; }
    #typewriter { font-size: 18px; color: #666; margin-bottom: 20px; min-height: 24px; }
  </style>
</head>
<body>
  <div class="converter">
    <h1>USD Value</h1>
    <h2 id="typewriter"></h2>
    <p>1 USD = <span id="result">Select a currency</span></p>

    <div>
      <label><input type="radio" name="type" value="fiat" checked> FIAT</label>
      <label><input type="radio" name="type" value="crypto"> CRYPTO</label>
    </div>

    <div id="fiat-container">
      <select id="fiat-select" class="js-select2" style="width: 300px;"></select>
    </div>

    <div id="crypto-container" class="hidden">
      <select id="crypto-select" class="js-select2" style="width: 300px;"></select>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // Utilisation de jQuery pour une meilleure compatibilitÃ© avec Select2
    const fiatSelect = $("#fiat-select");
    const cryptoSelect = $("#crypto-select");
    const resultSpan = $("#result");
    const fiatContainer = $("#fiat-container");
    const cryptoContainer = $("#crypto-container");

    let fiatRates = {};

    async function loadFiatCurrencies() {
      const res = await fetch('https://v6.exchangerate-api.com/v6/0b93015e962b4696101c7715/latest/USD');
      const data = await res.json();
      fiatRates = data.conversion_rates;
      Object.keys(fiatRates).forEach(code => {
        const option = new Option(code, code); // new Option(text, value)
        fiatSelect.append(option);
      });
      fiatSelect.val("EUR").trigger("change"); // Select EUR by default and trigger change
    }

    async function loadCryptoCurrencies() {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/list?per_page=200&page=1');
      const data = await res.json();
      data.forEach(coin => {
        const optionText = `${coin.name} (${coin.symbol.toUpperCase()})`;
        const option = new Option(optionText, coin.id);
        cryptoSelect.append(option);
      });
      cryptoSelect.val("bitcoin").trigger("change"); // Select Bitcoin by default
    }

    async function fetchRate() {
      const selectedType = $('input[name="type"]:checked').val();
      if (selectedType === "fiat") {
        const value = fiatSelect.val();
        const rate = fiatRates[value];
        resultSpan.text(rate ? rate.toFixed(4) + ' ' + value : "Unavailable");
      } else if (selectedType === "crypto") {
        const value = cryptoSelect.val();
        if (!value) return;
        
        // Affiche un message de chargement
        resultSpan.text('Loading...');

        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${value}&vs_currencies=usd`);
        const data = await res.json();
        const usdValue = data[value]?.usd;
        if (usdValue && usdValue > 0) {
          const rate = 1 / usdValue;
          resultSpan.text(rate.toFixed(6) + ' ' + cryptoSelect.find('option:selected').text().split(' ')[1].replace(/[()]/g, ''));
        } else {
          resultSpan.text("Unavailable");
        }
      }
    }

    $('input[name="type"]').on('change', () => {
      const selectedType = $('input[name="type"]:checked').val();
      if (selectedType === "fiat") {
        fiatContainer.removeClass("hidden");
        cryptoContainer.addClass("hidden");
      } else {
        fiatContainer.addClass("hidden");
        cryptoContainer.removeClass("hidden");
      }
      fetchRate();
    });

    // CORRECTION : Utilisation de .on('change', ...) de jQuery
    fiatSelect.on("change", fetchRate);
    cryptoSelect.on("change", fetchRate);

    $(document).ready(async () => {
      $('.js-select2').select2({ placeholder: "Search currency...", allowClear: true });
      await loadFiatCurrencies();
      await loadCryptoCurrencies();
      fetchRate(); // Fetch initial rate
      typeWriter();
    });

    // Typewriter animation
    const text = "We believe the USD is the most powerful currency in the world. That's why we fixed it.";
    let i = 0;
    function typeWriter() {
      if (i < text.length) {
        document.getElementById("typewriter").innerHTML += text.charAt(i);
        i++;
        setTimeout(typeWriter, 40);
      }
    }
  </script>
</body>
</html>